<SPAN><SPAN class=headers>Title:</SPAN></B><SPAN class=RefText> x86 Assembly Guide : Callee Rules : returns</SPAN></FONT></SPAN> 
<P></P>
<P><SPAN>When the subroutine is returns, it must follow these steps:</SPAN> </P>
<P></P>
<OL>
<LI><SPAN class=extract>Leave the return value in EAX</SPAN>. 
<P></P>
<LI><SPAN class=extract>Restore the old values of any callee-saved registers (EDI and ESI) that were modified</SPAN>. The register contents are restored by popping them from the stack. <SPAN class=extract>The registers should be popped in the inverse order that they were pushed</SPAN>. <BR>
<LI><SPAN class=extract>Deallocate local variables</SPAN>. The obvious way to do this might be to add the appropriate value to the stack pointer (since the space was allocated by subtracting the needed amount from the stack pointer). In practice, a less error-prone way to deallocate the variables is to move the value in the base pointer into the stack pointer:<SPAN>&nbsp;</SPAN><SPAN class=Keyword>mov&nbsp;esp,&nbsp;ebp</SPAN>. This works because the base pointer always contains the value that the stack pointer contained immediately prior to the allocation of the local variables. <BR>
<LI><SPAN class=extract>Immediately before returning, restore the caller's base pointer value by popping EBP off the stack</SPAN>. Recall that the first thing we did on entry to the subroutine was to push the base pointer to save its old value. <BR>
<LI><SPAN class=extract>Finally, return to the caller by executing a<SPAN>&nbsp;</SPAN><SPAN class=Keyword>ret</SPAN><SPAN>&nbsp;</SPAN>instruction. This instruction will find and remove the appropriate return address from the stack</SPAN></LI></OL>