<STRONG><FONT color=blue>How does thread/process switching work in Pintos? : </FONT></STRONG>
<H2><SPAN class=headers>Title:</SPAN></B><SPAN class=RefText> How does thread/process switching work in Pintos? : Threads in memory</SPAN></FONT></FONT></H2>
<P>All the information for a thread is contained in a single page of memory (4 KB in Pintos). The<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>struct containing information about the thread is stored at the bottom of the page, and the stack grows from the top to the bottom (see<SPAN>&nbsp;</SPAN><A class="reference external" href="https://uchicago-cs.github.io/pintos/pintos_6.html#SEC97"><FONT color=#0066cc>A.2.1 struct thread</FONT></A><SPAN>&nbsp;</SPAN>in the Pintos documentation for more details).</P>
<P>Suppose we have a thread that runs a function called<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_one()</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>(i.e., when we called<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_create</FONT></SPAN></CODE>, we passed<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_one</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>as the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">function</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>parameter). We do not need to worry about the details of how the thread is created; we will simply assume it is running.</P>
<P>The first entry in the stack for this thread actually isn&#8217;t<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_one</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>but, rather, an entry for a Pintos function called<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">kernel_thread</FONT></SPAN></CODE>. This function acts as a wrapper for the thread&#8217;s<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">function</FONT></SPAN></CODE>, ensuring that the thread exits as soon as the function returns. This is the code for<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">kernel_thread</FONT></SPAN></CODE>:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Function</SPAN> <SPAN class=n style="BOX-SIZING: border-box">used</SPAN> <SPAN class=k style="BOX-SIZING: border-box; FONT-WEIGHT: bold; COLOR: rgb(0,112,32)">as</SPAN> <SPAN class=n style="BOX-SIZING: border-box">the</SPAN> <SPAN class=n style="BOX-SIZING: border-box">basis</SPAN> <SPAN class=k style="BOX-SIZING: border-box; FONT-WEIGHT: bold; COLOR: rgb(0,112,32)">for</SPAN> <SPAN class=n style="BOX-SIZING: border-box">a</SPAN> <SPAN class=n style="BOX-SIZING: border-box">kernel</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">static</SPAN> <SPAN class=n style="BOX-SIZING: border-box">void</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">kernel_thread</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=n style="BOX-SIZING: border-box">thread_func</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*</SPAN><SPAN class=n style="BOX-SIZING: border-box">function</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN> <SPAN class=n style="BOX-SIZING: border-box">void</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*</SPAN><SPAN class=n style="BOX-SIZING: border-box">aux</SPAN><SPAN class=p style="BOX-SIZING: border-box">)</SPAN>
<SPAN class=p style="BOX-SIZING: border-box">{</SPAN>
  <SPAN class=n style="BOX-SIZING: border-box">ASSERT</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=n style="BOX-SIZING: border-box">function</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">!=</SPAN> <SPAN class=n style="BOX-SIZING: border-box">NULL</SPAN><SPAN class=p style="BOX-SIZING: border-box">);</SPAN>

  <SPAN class=n style="BOX-SIZING: border-box">intr_enable</SPAN> <SPAN class=p style="BOX-SIZING: border-box">();</SPAN>       <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">The</SPAN> <SPAN class=n style="BOX-SIZING: border-box">scheduler</SPAN> <SPAN class=n style="BOX-SIZING: border-box">runs</SPAN> <SPAN class=k style="BOX-SIZING: border-box; FONT-WEIGHT: bold; COLOR: rgb(0,112,32)">with</SPAN> <SPAN class=n style="BOX-SIZING: border-box">interrupts</SPAN> <SPAN class=n style="BOX-SIZING: border-box">off</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
  <SPAN class=n style="BOX-SIZING: border-box">function</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=n style="BOX-SIZING: border-box">aux</SPAN><SPAN class=p style="BOX-SIZING: border-box">);</SPAN>       <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Execute</SPAN> <SPAN class=n style="BOX-SIZING: border-box">the</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread</SPAN> <SPAN class=n style="BOX-SIZING: border-box">function</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
  <SPAN class=n style="BOX-SIZING: border-box">thread_exit</SPAN> <SPAN class=p style="BOX-SIZING: border-box">();</SPAN>       <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">If</SPAN> <SPAN class=n style="BOX-SIZING: border-box">function</SPAN><SPAN class=p style="BOX-SIZING: border-box">()</SPAN> <SPAN class=n style="BOX-SIZING: border-box">returns</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN> <SPAN class=n style="BOX-SIZING: border-box">kill</SPAN> <SPAN class=n style="BOX-SIZING: border-box">the</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
<SPAN class=p style="BOX-SIZING: border-box">}</SPAN></PRE>
<P>That<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_one</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>function may itself call other functions, which may call other functions, etc. The information about each function call is added to the stack (see<SPAN>&nbsp;</SPAN><A class="reference external" href="https://uchicago-cs.github.io/pintos/pintos_3.html#SEC50"><FONT color=#0066cc>3.5 80x86 Calling Convention</FONT></A><SPAN>&nbsp;</SPAN>in the Pintos documentation for details on the exact format for each stack entry).</P>
<P>Let&#8217;s say the thread is in the middle of running function<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">foobar()</FONT></SPAN></CODE>. The thread&#8217;s memory may look like this:</P><img style="HEIGHT: 277px; WIDTH: 399px" alt=_images/stack1.png src="https://uchicago-cs.github.io/mpcs52030/_images/stack1.png" width=830 height=509> 
<P>During the execution of the thread, the CPU&#8217;s<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">esp</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>register will point to the bottom-most address of the stack (or the &#8220;top&#8221; of the stack).</P>
<DIV></DIV>
<DIV id=what-happens-during-an-interrupt class=section>