<strong><font color="blue">How does thread/process switching work in Pintos? : </font></strong><h2>Switching between processes<A title="Permalink to this headline" class=headerlink href="https://uchicago-cs.github.io/mpcs52030/switch.html#switching-between-processes"></A></H2>
<P>Now that we&#8217;ve seen all of the above, it turns out that process switching is simply a combination of thread switching and and switching between kernelspace and userspace. Basically, when a process is running, a timer interrupt will yield control of the CPU back to the kernel, which will result in the interrupt handling procedure we described earlier (eventually resulting in a call to<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_tick</FONT></SPAN></CODE>). At that point, if we preempt the current thread (and its associated process), we switch to a different kernel thread as described earlier and, if this kernel thread is associated with a process, we switch back to userspace.</P>
<P>The main difference is that switching to a new process will also involve calling<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">process_activate</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>from<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_schedule_tail</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>(a function that is run<SPAN>&nbsp;</SPAN><EM>after</EM><SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE>, but before returning from the interrupt handler).<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">process_activate</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>(<A class="reference external" href="https://github.com/uchicago-cs/pintos/blob/master/src/userprog/process.c#L119-L133"><FONT color=#0066cc>source code</FONT></A>) updates the CPU&#8217;s<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">cr3</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>register to<SPAN>&nbsp;</SPAN><A class="reference external" href="http://wiki.osdev.org/Setting_Up_Paging"><FONT color=#0066cc>point to the page directory</FONT></A><SPAN>&nbsp;</SPAN>for the process that is now running, and also saves the value of<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">esp</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>to the TSS (<A class="reference external" href="https://github.com/uchicago-cs/pintos/blob/master/src/userprog/tss.c#L101-L106"><FONT color=#0066cc>source code</FONT></A>).