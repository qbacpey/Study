<SPAN class=headers>Title:</SPAN></B><SPAN class=RefText> C.1 Understanding Threads</SPAN></FONT> 
<P></P>
<P>The &#64257;rst step is to read and understand the code for the thread system. Pintos already implements thread creation and thread completion, a simple scheduler to switch between threads, and synchronization primitives (semaphores, locks, condition variables, and optimization barriers).</P>
<P>Pintos &#24050;&#32463;&#23454;&#29616;&#20102;&#32447;&#31243;&#21019;&#24314;&#21644;&#32447;&#31243;&#23436;&#25104;&#65292;&#19968;&#20010;&#31616;&#21333;&#30340;&#35843;&#24230;&#22120;&#65288;&#29992;&#20110;&#22312;&#32447;&#31243;&#20013;&#20999;&#25442;&#65289;&#65292;&#20197;&#21450;&#19968;&#20123;&#29992;&#20110;&#21516;&#27493;&#30340;&#21407;&#35821;&#65288;semaphores, locks, condition variables, optimization barriers&#65289;</P>
<P>Some of this code might seem slightly mysterious. You can read through parts of the source code to see what&#8217;s going on. If you like, you can add calls to printf() almost anywhere, then recompile and run to see what happens and in what order. You can also run the kernel in a debugger and set breakpoints at interesting spots, step through code and examine data, and so on.</P><SPAN class=extract>
<P>When a thread is created, the creator speci&#64257;es a function for the thread to run, as one of the arguments to thread_create(). The &#64257;rst time the thread is scheduled and runs, it starts executing from the beginning of that function. When the function returns, the thread terminates. Each thread, therefore, acts like a mini-program running inside Pintos, with the function passed to thread_create() acting like main().</P>
<P>&#24403;&#32447;&#31243;&#34987;&#21019;&#24314;&#26159;&#65292;thread_create &#20250;&#20026;&#35813;&#32447;&#31243;&#25552;&#20379;&#19968;&#20010;&#20989;&#25968;&#65292;&#35813;&#32447;&#31243;&#21021;&#27425;&#34987;&#35843;&#24230;&#36816;&#34892;&#30340;&#26102;&#20505;&#23601;&#20250;&#25191;&#34892;&#35813;&#20989;&#25968;&#12290;&#24403;&#35813;&#20989;&#25968;&#36820;&#22238;&#65292;&#32447;&#31243;&#21363;&#32456;&#27490;</P></SPAN><SPAN class=extract>
<P>At any given time, exactly one thread runs and the rest become inactive. The scheduler decides which thread to run next. (If no thread is ready to run, then the special &#8220;idle&#8221; thread runs.) </P>
<P>&#24403;&#31995;&#32479;&#20013;&#27809;&#26377;&#38656;&#35201;&#36816;&#34892;&#30340;&#32447;&#31243;&#26102;&#65292;&#19968;&#20010;&#29305;&#21035;&#30340;&#38386;&#32622;&#32447;&#31243;&#20250;&#34987;&#36816;&#34892;</P></SPAN><SPAN class=extract>
<P>The mechanics of a context switch are in threads/switch.S, which is x86 assembly code. It saves the state of the currently running thread and restores the state of the next thread onto the CPU.</P>
<P>&#23454;&#29616;&#32447;&#31243;&#20999;&#25442;&#30340;&#20195;&#30721;&#20301;&#20110; threads/switch.S &#20013;&#65292;&#23427;&#30340;&#24037;&#20316;&#26159;&#20445;&#23384;&#32447;&#31243;&#29366;&#24577;&#24182;&#23558;&#26032;&#32447;&#31243;&#21152;&#36733;&#21040; CPU &#20013;</P></SPAN><SPAN class=extract>
<P>Using GDB, try tracing through a context switch to see what happens. You can set a breakpoint on schedule() to start out, and then single-step from there (use &#8220;step&#8221; instead of &#8220;next&#8221;). Be sure to keep track of each thread&#8217;s address and state, and what procedures are on the call stack for each thread (try &#8220;backtrace&#8221;). You will notice that when one thread calls switch_threads(), another thread starts running, and the &#64257;rst thing the new thread does is to return from switch_threads(). You will understand the thread system once you understand why and how the switch_threads() that gets called is di&#64256;erent from the switch_threads() that returns.</P>
<P>&#22914;&#26524;&#24819;&#35201;&#35843;&#35797;&#32447;&#31243;&#19978;&#19979;&#25991;&#20999;&#25442;&#30340;&#36807;&#31243;&#65292;&#21487;&#20197;&#22312; schedule() &#20013;&#35774;&#32622;&#26029;&#28857;&#24182;&#19981;&#20165;&#65292;&#25351;&#30340;&#27880;&#24847;&#30340;&#26159;&#65292;&#24403;&#26576;&#20010;&#32447;&#31243;&#35843;&#29992;&#20102; switch_threads() &#20043;&#21518;&#65292;&#21478;&#19968;&#20010;&#32447;&#31243;&#23601;&#20250;&#24320;&#22987;&#36816;&#34892;&#65292;&#26032;&#32447;&#31243;&#25152;&#20570;&#30340;&#31532;&#19968;&#20214;&#20107;&#26159;&#20174; switch_threads() &#20013;&#36820;&#22238;</P>
<P></SPAN>