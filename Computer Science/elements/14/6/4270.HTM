<STRONG><FONT color=blue>How does thread/process switching work in Pintos? : </FONT></STRONG>
<H2>What happens during a thread switch<A title="Permalink to this headline" class=headerlink href="https://uchicago-cs.github.io/mpcs52030/switch.html#what-happens-during-a-thread-switch"></A></H2>
<P>If a thread has used up its timeslice,<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_tick</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>will call the function<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">intr_yield_on_return</FONT></SPAN></CODE>. However,<SPAN>&nbsp;</SPAN><EM>this doesn&#8217;t yield to the next thread at that point</EM>. Instead, it modifies a flag to let the interrupt handler know that, before returning from the interrupt, it should perform a context switch to a different thread (so that, when we return from the interrupt, we do so with the context, i.e., stack and program counter, of a different thread).</P>
<P>So, after<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_tick</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>and<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">timer_interrupt</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>return,<BR><SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">intr_handler</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>will call<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread_yield</FONT></SPAN></CODE>, which will call<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">schedule</FONT></SPAN></CODE>.<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">schedule</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>picks the next thread to run and calls a function<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE>, implemented in x86 assembly, with two parameters:<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">cur</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>(a pointer to the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>struct of the current thread, i.e., the one that is being preempted) and<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">next</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>(a pointer to the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>struct of the next thread to run).</P>
<P>So, the stack will look like this:</P><img style="HEIGHT: 321px; WIDTH: 482px" alt=_images/stack3.png src="https://uchicago-cs.github.io/mpcs52030/_images/stack3.png" width=964 height=528> 
<P><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>is implemented in<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch.S</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>(<A class="reference external" href="https://github.com/uchicago-cs/pintos/blob/master/src/threads/switch.S"><FONT color=#0066cc>source code</FONT></A>)</P>
<P>The key to understanding<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>is to first understand that, if we&#8217;re switching to another thread, that other thread must&#8217;ve also been running<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>when it was preempted. In fact, a thread that voluntarily or involuntarily yielded the CPU will always have a stack that looks like one of the following:</P><img style="HEIGHT: 294px; WIDTH: 499px" alt=_images/stack4.png src="https://uchicago-cs.github.io/mpcs52030/_images/stack4.png" width=1157 height=597> 
<P>The intuition behind<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>is that, to switch to another thread, we just need to &#8220;switch the stacks&#8221; (because every thread is guaranteed to be running<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>at the point it was preempted), and we can do this simply by changing the value of<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">esp</FONT></SPAN></CODE>. Let&#8217;s take a closer look at how this happens.</P>
<P>Right after calling<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE>, the bottom of the stack will look like this:</P><img style="HEIGHT: 133px; WIDTH: 494px" alt=_images/stack5.png src="https://uchicago-cs.github.io/mpcs52030/_images/stack5.png" width=541 height=144> 
<P>The address of the start of the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>stack frame (<CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">0x0C00</FONT></SPAN></CODE>) is arbitrary and has no deep significance. However, all the other values shown would be consistent with the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>stack frame starting at<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">0x0C00</FONT></SPAN></CODE>.</P>
<P>First of all,<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>needs to save some registers (this is simply required by the x86 architecture):</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=n style="BOX-SIZING: border-box">pushl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">ebx</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">pushl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">ebp</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">pushl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">esi</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">pushl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">edi</SPAN></PRE>
<P>And our stack will now look like this:</P><img style="HEIGHT: 204px; WIDTH: 406px" alt=_images/stack6.png src="https://uchicago-cs.github.io/mpcs52030/_images/stack6.png" width=646 height=291> 
<P>Before we see what happens next, recall that the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>struct stores information about each thread:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=n style="BOX-SIZING: border-box">struct</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread</SPAN>
  <SPAN class=p style="BOX-SIZING: border-box">{</SPAN>
    <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Owned</SPAN> <SPAN class=n style="BOX-SIZING: border-box">by</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN><SPAN class=n style="BOX-SIZING: border-box">c</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
    <SPAN class=n style="BOX-SIZING: border-box">tid_t</SPAN> <SPAN class=n style="BOX-SIZING: border-box">tid</SPAN><SPAN class=p style="BOX-SIZING: border-box">;</SPAN>                          <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Thread</SPAN> <SPAN class=n style="BOX-SIZING: border-box">identifier</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
    <SPAN class=n style="BOX-SIZING: border-box">enum</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread_status</SPAN> <SPAN class=n style="BOX-SIZING: border-box">status</SPAN><SPAN class=p style="BOX-SIZING: border-box">;</SPAN>          <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Thread</SPAN> <SPAN class=n style="BOX-SIZING: border-box">state</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
    <SPAN class=n style="BOX-SIZING: border-box">char</SPAN> <SPAN class=n style="BOX-SIZING: border-box">name</SPAN><SPAN class=p style="BOX-SIZING: border-box">[</SPAN><SPAN class=mi style="BOX-SIZING: border-box; COLOR: rgb(32,128,80)">16</SPAN><SPAN class=p style="BOX-SIZING: border-box">];</SPAN>                      <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Name</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=k style="BOX-SIZING: border-box; FONT-WEIGHT: bold; COLOR: rgb(0,112,32)">for</SPAN> <SPAN class=n style="BOX-SIZING: border-box">debugging</SPAN> <SPAN class=n style="BOX-SIZING: border-box">purposes</SPAN><SPAN class=p style="BOX-SIZING: border-box">)</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>
    <SPAN class=n style="BOX-SIZING: border-box">uint8_t</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*</SPAN><SPAN class=n style="BOX-SIZING: border-box">stack</SPAN><SPAN class=p style="BOX-SIZING: border-box">;</SPAN>                     <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">Saved</SPAN> <SPAN class=n style="BOX-SIZING: border-box">stack</SPAN> <SPAN class=n style="BOX-SIZING: border-box">pointer</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>

    <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">/*</SPAN> <SPAN class=n style="BOX-SIZING: border-box">etc</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">*/</SPAN>

  <SPAN class=p style="BOX-SIZING: border-box">}</SPAN></PRE>
<P>Notice how it contains a<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">stack</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>field. This field is used to save the value of<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">esp</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>when a thread is preempted. However, in x86 assembly we can&#8217;t just write<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">t-&gt;stack</FONT></SPAN></CODE>. Instead, if we want to access that value in the struct, we need the address of the struct in memory<SPAN>&nbsp;</SPAN><EM>and</EM><SPAN>&nbsp;</SPAN>the offset (in bytes) of the field we want to access. This is defined in<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">thread.c</FONT></SPAN></CODE>:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=n style="BOX-SIZING: border-box">uint32_t</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread_stack_ofs</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">=</SPAN> <SPAN class=n style="BOX-SIZING: border-box">offsetof</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=n style="BOX-SIZING: border-box">struct</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN> <SPAN class=n style="BOX-SIZING: border-box">stack</SPAN><SPAN class=p style="BOX-SIZING: border-box">);</SPAN></PRE>
<P>Since we need to use this value in<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE>, we load it into register<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">edx</FONT></SPAN></CODE>:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">.</SPAN><SPAN class=n style="BOX-SIZING: border-box">globl</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread_stack_ofs</SPAN>
        <SPAN class=n style="BOX-SIZING: border-box">mov</SPAN> <SPAN class=n style="BOX-SIZING: border-box">thread_stack_ofs</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">edx</SPAN></PRE>
<P>Next,<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch.h</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>defines SWITCH_CUR and SWITCH_NEXT as the offset of cur and next within the stack frame (20 and 24; see how this matches with what is shown in the earlier figure). In x86 assembly, the expression<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">SWITCH_CUR(%esp)</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>becomes<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">20(%esp)</FONT></SPAN></CODE>, which translates to the memory address<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><FONT face="Courier New"><SPAN class=pre>esp</SPAN><SPAN>&nbsp;</SPAN><SPAN class=pre>+</SPAN><SPAN>&nbsp;</SPAN><SPAN class=pre>20</SPAN></FONT></CODE>. In other words, this gives us the address of the current thread (<CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">cur</FONT></SPAN></CODE>).</P>
<P>Similary,<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">SWITCH_NEXT(%esp)</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>gives us the address of the<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">next</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>thread.</P>
<P>So, the following piece of assembly code:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=n style="BOX-SIZING: border-box">movl</SPAN> <SPAN class=n style="BOX-SIZING: border-box">SWITCH_CUR</SPAN><SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">esp</SPAN><SPAN class=p style="BOX-SIZING: border-box">),</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">eax</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">movl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">esp</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">eax</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">edx</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN><SPAN class=mi style="BOX-SIZING: border-box; COLOR: rgb(32,128,80)">1</SPAN><SPAN class=p style="BOX-SIZING: border-box">)</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">movl</SPAN> <SPAN class=n style="BOX-SIZING: border-box">SWITCH_NEXT</SPAN><SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">esp</SPAN><SPAN class=p style="BOX-SIZING: border-box">),</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">ecx</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">movl</SPAN> <SPAN class=p style="BOX-SIZING: border-box">(</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">ecx</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">edx</SPAN><SPAN class=p style="BOX-SIZING: border-box">,</SPAN><SPAN class=mi style="BOX-SIZING: border-box; COLOR: rgb(32,128,80)">1</SPAN><SPAN class=p style="BOX-SIZING: border-box">),</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">esp</SPAN></PRE>
<P>Is the equivalent of doing this:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=n style="BOX-SIZING: border-box">cur</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">-&gt;</SPAN><SPAN class=n style="BOX-SIZING: border-box">stack</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">=</SPAN> <SPAN class=n style="BOX-SIZING: border-box">esp</SPAN><SPAN class=p style="BOX-SIZING: border-box">;</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">esp</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">=</SPAN> <SPAN class=nb style="BOX-SIZING: border-box; COLOR: rgb(0,112,32)">next</SPAN><SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">-&gt;</SPAN><SPAN class=n style="BOX-SIZING: border-box">stack</SPAN><SPAN class=p style="BOX-SIZING: border-box">;</SPAN></PRE>
<P>In other words, we save the stack pointer of the current thread, and set<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">esp</FONT></SPAN></CODE><SPAN>&nbsp;</SPAN>to point to the (previously saved) stack pointer of the next thread to run.</P>
<P>Once we&#8217;ve done this, we have switched threads, and all that remains is to restore the registers we had previously pushed onto the stack, and return from<SPAN>&nbsp;</SPAN><CODE class="docutils literal"><SPAN class=pre><FONT face="Courier New">switch_threads</FONT></SPAN></CODE>:</P><PRE style='BOX-SIZING: border-box; FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(204,204,204) 1px solid; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(204,204,204) 1px solid; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(204,204,204) 1px solid; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(51,51,51); PADDING-BOTTOM: 9px; FONT-STYLE: normal; PADDING-TOP: 9px; PADDING-LEFT: 9px; BORDER-LEFT: rgb(204,204,204) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 10px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 9px; BACKGROUND-COLOR: rgb(245,245,245); TEXT-INDENT: 0px; overflow-wrap: break-word; border-radius: 4px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial'><SPAN class=n style="BOX-SIZING: border-box">popl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">edi</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">popl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">esi</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">popl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">ebp</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">popl</SPAN> <SPAN class=o style="BOX-SIZING: border-box; COLOR: rgb(102,102,102)">%</SPAN><SPAN class=n style="BOX-SIZING: border-box">ebx</SPAN>
<SPAN class=n style="BOX-SIZING: border-box">ret</SPAN></PRE>
<DIV></DIV>
<DIV id=switching-between-kernelspace-and-userspace class=section>